# 엣지 케이스 및 예외 처리 (Edge Cases & Exception Handling)

## 목적
이 문서는 Opportunity Cost Calculator에서 처리하는 모든 엣지 케이스와 예외 상황을 상세히 정리합니다.

---

## 📋 전체 엣지 케이스 요약

총 16개 케이스를 정의하고 테스트했습니다:
- **입력 검증 (6개)**: 음수, 0원, 상한선 등
- **사용자 실수 (4개)**: 단위 혼동, 월급 착각, 소수점 등
- **경계값 (2개)**: 시간 0분, 비용 0원
- **동점/비교 (1개)**: 총비용 동일
- **형식 오류 (1개)**: JSON 형식
- **시스템 오류 (2개)**: 네트워크, 캐시

---

## 1️⃣ 입력 검증 케이스 (6개)

### 1.1 시급 0원

**입력 예시**:
```json
{
  "wage": 0,
  "optionA": { "time": 10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 시급이 0원이면 시간 비용 계산 불가
- 분당 가치 = wage / 60 = 0 / 60 = 0원

**처리 방식**:
- ❌ **에러 발생**
- HTTP 400 Bad Request
- 메시지: "시급은 1원 이상이어야 합니다"

**테스트**: ✅ `OpportunityCostServiceTest.testInvalidWageZero()`

---

### 1.2 음수 시급

**입력 예시**:
```json
{
  "wage": -15000,
  "optionA": { "time": 10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 음수 시급은 현실적으로 불가능
- 계산 로직이 의미 없는 결과 생성

**처리 방식**:
- ❌ **에러 발생**
- HTTP 400 Bad Request
- 메시지: "시급은 1원 이상이어야 합니다"

**테스트**: ✅ `OpportunityCostServiceTest.testInvalidWageNegative()`

---

### 1.3 음수 소요 시간

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": -10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 음수 시간은 논리적으로 불가능
- 계산 결과가 왜곡됨

**처리 방식**:
- ❌ **에러 발생**
- HTTP 400 Bad Request
- 메시지: "소요 시간은 0분 이상이어야 합니다"

**테스트**: ✅ `OpportunityCostServiceTest.testInvalidTimeNegative()`

---

### 1.4 음수 직접 비용

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": 10, "cost": -5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 음수 비용은 현실적으로 불가능 (환급/적립 제외)
- 계산 로직이 의미 없는 결과 생성

**처리 방식**:
- ❌ **에러 발생**
- HTTP 400 Bad Request
- 메시지: "직접 비용은 0원 이상이어야 합니다"

**참고**: 환급이나 적립금은 "비용 절감"으로 간주하여 직접 비용에서 차감

**테스트**: ✅ `OpportunityCostServiceTest.testInvalidCostNegative()`

---

### 1.5 큰 값 입력 (이상값 감지)

**입력 예시**:
```json
{
  "wage": 1000000,
  "optionA": { "time": 10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 시급 100만원 (연봉 약 24억) → 입력 실수 가능성
- 사용자가 의도하지 않은 결과 발생

**처리 방식**:
- ⚠️ **확인 팝업 (클라이언트 측)**
- "시급 1,000,000원이 맞습니까? (일반적으로 시급은 10,000~50,000원 범위)"
- 사용자 확인 후 계속 진행 가능

**경계값**: 시급 100,000원 이상

**테스트**: ✅ `OpportunityCostControllerTest.testLargeWageInput()`

---

### 1.6 시급 상한선 초과

**입력 예시**:
```json
{
  "wage": 200000000,
  "optionA": { "time": 10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 시급 2억원 (연봉 약 4,800억) → 비현실적
- 계산 오버플로우 위험
- Integer 범위 초과 가능성 (2,147,483,647원)

**처리 방식**:
- ❌ **에러 발생**
- HTTP 400 Bad Request
- 메시지: "시급은 1억원 이하여야 합니다"

**상한선**: 100,000,000원 (1억원)

**테스트**: ✅ `OpportunityCostServiceTest.testWageExceedsLimit()`

---

## 2️⃣ 사용자 실수 케이스 (4개)

### 2.1 시간 단위 혼동

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": 2, "cost": 5000 },  // 2시간을 2분으로 착각
  "optionB": { "time": 120, "cost": 3000 }  // 120분 = 2시간
}
```

**문제**:
- 사용자가 "2시간"을 "2분"으로 입력
- 또는 "120분"과 "2시간"을 혼동
- 결과: 시간 비용 계산 오류 (60배 차이)

**처리 방식**:
- ⚠️ **입력 가이드 표시 (클라이언트 측)**
- 입력 필드 옆에 "분 단위로 입력 (예: 2시간 = 120분)"
- 입력 후 자동 변환 제안: "2시간 → 120분"

- ⚠️ **이상값 감지**
- 소요 시간이 10분 미만이고 직접 비용이 10,000원 이상인 경우
- "소요 시간이 너무 짧지 않나요? (2분 → 2시간?)" 경고

**구현 상태**: 
- ✅ 입력 가이드 UI에 표시
- ⚠️ 자동 감지 미구현 (향후 개선)

**테스트**: ✅ `OpportunityCostControllerTest.testTimeUnitGuidance()`

---

### 2.2 시급 vs 월급 혼동

**입력 예시**:
```json
{
  "wage": 4000000,  // 월급 400만원을 시급으로 착각
  "optionA": { "time": 10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 사용자가 월급을 시급 입력란에 입력
- 예: 월급 400만원 → 시급 4,000,000원으로 착각
- 실제 시급: 4,000,000 ÷ 209시간 = 약 19,139원

**처리 방식**:
- ⚠️ **경고 팝업 (클라이언트 측)**
- 시급이 300,000원 이상인 경우
- "월급을 입력하셨나요? 시급 = 월급 ÷ 209시간"
- "월급 4,000,000원 → 시급 약 19,139원"
- 자동 변환 옵션 제공

**경계값**: 시급 300,000원 이상 (월급 착각 가능성)

**구현 상태**:
- ✅ 경고 팝업 구현
- ✅ 자동 변환 계산기 제공 (209시간 기준)

**테스트**: ✅ `OpportunityCostControllerTest.testMonthlySalaryConfusion()`

**참고**: 
- 209시간 = 월 평균 근로시간 (주 40시간 × 52주 ÷ 12개월)
- 법정 근로시간 기준

---

### 2.3 소수점 입력

**입력 예시**:
```json
{
  "wage": 15000.5,
  "optionA": { "time": 10.7, "cost": 5000.99 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 시급, 시간, 비용에 소수점 입력
- 원 단위 계산에서 소수점 처리 필요
- 예: 10.7분 → 10분? 11분?

**처리 방식**:
- ✅ **허용 + 자동 처리**
- 시간: 소수점 허용 (예: 10.5분 = 10분 30초)
- 비용: 소수점 절사 (Math.floor)
  - 예: 5,000.99원 → 5,000원
- 시급: 정수로 반올림 권장하지만 소수점 허용

**계산 로직**:
```java
// 시간 비용 계산
double timeCost = (wage / 60.0) * time;
int finalTimeCost = (int) Math.floor(timeCost);

// 총비용 계산
int totalCost = directCost + finalTimeCost;
```

**이유**: 
- 과대평가 방지 (Math.floor)
- 예: 2,500.7원 → 2,500원 (사용자에게 유리)

**구현 상태**: ✅ 완전 구현됨

**테스트**: ✅ `OpportunityCostServiceTest.testDecimalInputHandling()`

---

### 2.4 다안 비교 제한 초과

**입력 예시**:
```json
{
  "wage": 15000,
  "options": [
    { "name": "A", "time": 10, "cost": 5000 },
    { "name": "B", "time": 20, "cost": 3000 },
    { "name": "C", "time": 15, "cost": 4000 },
    { "name": "D", "time": 25, "cost": 2500 },
    { "name": "E", "time": 30, "cost": 2000 },
    { "name": "F", "time": 35, "cost": 1500 },  // 6개 → 제한 초과
    ...
  ]
}
```

**문제**:
- README에서 "3~5개 선택지 비교" 명시 (74줄)
- 6개 이상 입력 시 UI 복잡도 증가
- 성능 및 UX 저하 가능성

**처리 방식**:
- ⚠️ **경고 + 제한 (클라이언트 측)**
- 5개까지 입력란 표시
- 6번째 추가 시도 시: "최대 5개까지 비교 가능합니다"
- "더 많은 선택지는 2회로 나누어 비교하세요" 안내

**서버 측**:
- ✅ **허용 (제한 없음)**
- 입력된 모든 선택지 계산 (10개라도 허용)
- 이유: 클라이언트에서 제한하지만, API는 유연하게 대응

**구현 상태**:
- ✅ 클라이언트: 5개 제한 (UI)
- ✅ 서버: 제한 없음 (확장성)

**테스트**: 
- ✅ `OpportunityCostControllerTest.testMultiComparisonLimit()`
- ✅ 10개 입력 테스트 통과

---

## 3️⃣ 경계값 케이스 (2개)

### 3.1 소요 시간 0분

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": 0, "cost": 5000 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 시간이 0분인 경우
- 예: 온라인 구매 (즉시), 즉석 식품

**처리 방식**:
- ✅ **정상 허용**
- 시간 비용 = (15,000 ÷ 60) × 0 = 0원
- 총비용 = 직접 비용 + 0 = 5,000원

**유스케이스**:
- 온라인 주문 vs 매장 방문
- 즉석 식품 vs 조리 필요 식품
- 택배 수령 vs 직접 픽업

**구현 상태**: ✅ 완전 구현됨

**테스트**: ✅ `OpportunityCostServiceTest.testZeroTimeAllowed()`

---

### 3.2 직접 비용 0원

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": 10, "cost": 0 },
  "optionB": { "time": 20, "cost": 3000 }
}
```

**문제**:
- 직접 비용이 0원인 경우
- 예: 무료 샘플, 집에 있는 재료, 도보 이동

**처리 방식**:
- ✅ **정상 허용**
- 시간 비용 = (15,000 ÷ 60) × 10 = 2,500원
- 총비용 = 0 + 2,500 = 2,500원

**유스케이스**:
- 무료 배송 vs 유료 배송
- 집 재료로 요리 vs 외식
- 도보 vs 택시

**구현 상태**: ✅ 완전 구현됨

**테스트**: ✅ `OpportunityCostServiceTest.testZeroCostAllowed()`

---

## 4️⃣ 동점/비교 케이스 (1개)

### 4.1 총비용 동일

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": 10, "cost": 5000 },
  "optionB": { "time": 20, "cost": 2500 }
}
```

**계산**:
```
분당 가치 = 15,000 ÷ 60 = 250원/분

A 총비용 = 5,000 + (250 × 10) = 7,500원
B 총비용 = 2,500 + (250 × 20) = 7,500원
```

**문제**:
- 두 선택지의 총비용이 정확히 동일
- 어느 것을 추천해야 하는가?

**처리 방식**:
- ✅ **"동일" 표시**
- 추천: "두 선택지 모두 동일한 총비용 (7,500원)"
- 차액: 0원
- 추가 정보: "다른 기준으로 선택하세요 (편의성, 선호도 등)"

**UI 표시**:
```
결과: 두 선택지 모두 동일 (총비용 7,500원)
추천: 편의성이나 선호도로 선택하세요
차액: 0원
```

**구현 상태**: ✅ 완전 구현됨

**테스트**: ✅ `OpportunityCostServiceTest.testEqualTotalCost()`

---

## 5️⃣ 형식 오류 케이스 (1개)

### 5.1 잘못된 JSON 형식

**입력 예시**:
```json
{
  "wage": 15000,
  "optionA": { "time": 10 },  // cost 누락
  "optionB": "invalid"  // 객체가 아닌 문자열
}
```

**문제**:
- 필수 필드 누락 (time, cost)
- 잘못된 데이터 타입
- JSON 파싱 실패

**처리 방식**:
- ❌ **에러 발생**
- HTTP 400 Bad Request
- 메시지: "요청 형식이 올바르지 않습니다"
- 상세: "optionA.cost 필드가 필요합니다"

**검증 항목**:
1. wage: 필수, 숫자
2. optionA/B: 필수, 객체
3. optionA/B.time: 필수, 숫자
4. optionA/B.cost: 필수, 숫자

**구현 상태**: ✅ Spring Validation 적용

**테스트**: ✅ `OpportunityCostControllerTest.testInvalidJsonFormat()`

---

## 6️⃣ 시스템 오류 케이스 (2개)

### 6.1 네트워크/서버 오류

**상황**:
- API 호출 실패 (네트워크 끊김)
- 서버 타임아웃 (30초 초과)
- 서버 500 에러

**문제**:
- 사용자가 결과를 받지 못함
- 재시도 필요성
- 사용자 경험 저하

**처리 방식**:

**클라이언트 측**:
- ⚠️ **재시도 로직 (최대 3회)**
  1. 1차 실패 → 2초 후 재시도
  2. 2차 실패 → 5초 후 재시도
  3. 3차 실패 → 에러 메시지 표시

- ❌ **최종 에러 표시**
  - "서버 연결에 실패했습니다"
  - "잠시 후 다시 시도해주세요"
  - "문제가 지속되면 관리자에게 문의하세요"

**서버 측**:
- ✅ **타임아웃 설정**: 30초
- ✅ **에러 로깅**: 모든 500 에러 로그 기록
- ✅ **Health Check**: `/actuator/health` 엔드포인트

**구현 상태**:
- ✅ 클라이언트: 재시도 로직 구현
- ✅ 서버: 타임아웃 및 로깅 구현
- ⚠️ Health Check: Spring Actuator 설정 필요

**테스트**: 
- ✅ `OpportunityCostControllerTest.testNetworkTimeout()`
- ⚠️ 실제 네트워크 오류 시뮬레이션 미구현

---

### 6.2 캐시 오류

**상황**:
- 캐시 저장 실패 (메모리 부족)
- 캐시 조회 실패 (키 불일치)
- 캐시 만료 처리 오류

**문제**:
- 캐시가 제대로 작동하지 않으면?
- 성능 저하 가능성
- 사용자는 오류를 인지하지 못함

**처리 방식**:

**캐시 저장 실패**:
- ✅ **무시하고 계속 진행**
- 캐시 없이 정상 계산 수행
- 오류 로그 기록: "캐시 저장 실패, 계산 계속 진행"
- 사용자에게는 영향 없음

**캐시 조회 실패**:
- ✅ **새로 계산**
- 캐시 미스로 간주
- 정상 계산 수행 후 결과 반환

**캐시 용량 초과**:
- ✅ **LRU (Least Recently Used) 제거**
- 가장 오래된 캐시 항목 자동 삭제
- 새 항목 저장

**구현 상태**: ✅ 완전 구현됨 (CalculationCacheService)

**캐시 정책**:
- 저장 기간: 1시간
- 최대 항목: 1000개
- 제거 정책: LRU

**테스트**: ✅ `CalculationCacheServiceTest.testCacheFailureHandling()`

---

## 🧪 테스트 커버리지

### 단위 테스트 (OpportunityCostServiceTest)
- ✅ 1.1 시급 0원
- ✅ 1.2 음수 시급
- ✅ 1.3 음수 소요 시간
- ✅ 1.4 음수 직접 비용
- ✅ 1.6 시급 상한선 초과
- ✅ 2.3 소수점 입력
- ✅ 3.1 소요 시간 0분
- ✅ 3.2 직접 비용 0원
- ✅ 4.1 총비용 동일

### 통합 테스트 (OpportunityCostControllerTest)
- ✅ 1.5 큰 값 입력
- ✅ 2.1 시간 단위 혼동 (UI 가이드)
- ✅ 2.2 시급 vs 월급 혼동
- ✅ 2.4 다안 비교 제한
- ✅ 5.1 잘못된 JSON 형식
- ✅ 6.1 네트워크 오류 (타임아웃)

### 캐시 테스트 (CalculationCacheServiceTest)
- ✅ 6.2 캐시 오류 처리

---

## 📈 향후 개선 계획

### 추가 고려 사항
1. **입력 자동 보정**
   - "2시간" 문자열 입력 → 자동으로 120분 변환
   - 현재: UI 가이드만 제공

2. **사용자 피드백 수집**
   - 실제 사용자가 어떤 실수를 하는지 데이터 수집
   - 자주 발생하는 오류 패턴 분석

3. **AI 기반 이상값 감지**
   - 통계적으로 비정상적인 입력 자동 감지
   - 예: 시급 5,000원 + 소요 시간 300분 (5시간)

4. **다국어 지원**
   - 에러 메시지 다국어 처리
   - 입력 단위 (분, 시간, 초) 다양화

---

## 📝 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2026-02-13 | 초기 문서 작성 (16개 케이스) |

---

## 참고 문서
- [README.md](../README.md) - 엣지 케이스 요약
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - 실제 발생한 문제 해결
- [CHANGELOG.md](CHANGELOG.md) - 엣지 케이스 관련 변경 이력
